<!-- ===========================================================================
 * Test cLASS
 * @copyright Copyright 2016 Gerd Wagner, BTU (Germany) + ODU (VA, USA)
 * @author Gerd Wagner
 * @license The MIT License (MIT)
================================================================================ -->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta charset="utf-8">
  <title>cLASS-TestSuite01</title>
  <meta name="viewport" content="width=device-width, initial-scale = 1.0" />
  <link rel="stylesheet" href="../css/normalize.css" />
  <style>
    body { padding: 8px;}
    .failure {color: red;}
    .info {color: blue;}
    .okay {color: green;}
  </style>
</head>
<body>
 <h1>bUSINESSoBJECT Test Suite 02: Constraint Validation</h1>

 <script type="module">
 import dom from "../lib/dom.mjs";
 import {test, showSuccessMessage} from "./test.js";
 import eNUMERATION from "../src/eNUMERATION.mjs";
 import bUSINESSoBJECT from "../src/bUSINESSoBJECT.mjs";

 /****************************************
 *** Test code **************************
 ****************************************/
 try {
   const BookCategoryEL = new eNUMERATION("BookCategoryEL", ["novel","biography",
     "textbook","other"]);

   class Publisher extends bUSINESSoBJECT {
     constructor({name, address}) {
       super( name);
       this.address = address;
     }
   }

   Publisher.properties = {
     "name": {range: "NonEmptyString", isIdAttribute: true, min: 2, max: 20},
     "address": {range: "NonEmptyString", min: 5, max: 50},
   }
   Publisher.setup();

   class Book extends bUSINESSoBJECT {
     constructor({isbn, title, year, publisher, edition, category}) {
       super( isbn);
       this.title = title;
       this.year = year;
       if (publisher) this.publisher = publisher;
       if (edition) this.edition = edition;
       if (category) this.category = category;
     }
   }

   Book.properties = {
     "isbn": {
       range: "NonEmptyString", isIdAttribute: true, label: "ISBN", pattern: /\b\d{9}(\d|X)\b/,
       patternMessage: "The ISBN must be a 10-digit string or a 9-digit string followed by 'X'!"
     },
     "title": {range: "NonEmptyString", min: 2, max: 50},
     "year": {range: "Integer", min: 1459, max: () => (new Date()).getFullYear() + 1},
     "publisher": {range: "Publisher", optional: true},
     "edition": {range:"PositiveInteger", optional: true},
     "category": {range: BookCategoryEL, optional: true}
   }
   Book.setup();

   //*** Test 1 ***************************
   document.body.appendChild(dom.createElement("h2", {content: "Test 1: Valid data"}));
   try {
     let b1 = new Book({isbn: "123456789X", title: "Hello world", year: 2022});
     document.body.appendChild(dom.createElement("p", {content: "OKAY."}));
   } catch (e) {
     document.body.appendChild(dom.createElement("p", {content: "FAILED!"}));
     document.body.appendChild(dom.createElement("p", {content: e.constructor.name + ": " + e.message}));
   }
   //*** Test 2 ***************************
   document.body.appendChild(dom.createElement("h2", {content: "Test 2: Flawed ISBN"}));
   try {
     let b1 = new Book({
       isbn: "123456789",  // instead of "123456789X"
       title: "Hello world", year: 2022
     });
     document.body.appendChild(dom.createElement("p", {content: "FAILED!"}));
   } catch (e) {
     document.body.appendChild(dom.createElement("p", {content: "OKAY."}));
     document.body.appendChild(dom.createElement("p", {content: e.constructor.name + ": " + e.message}));
   }
   //*** Test 3 ***************************
   document.body.appendChild(dom.createElement("h2", {content: "Test 3: Missing value for ISBN"}));
   try {
     let b1 = new Book({title: "Hello world", year: 2022});
     document.body.appendChild(dom.createElement("p", {content: "FAILED!"}));
   } catch (e) {
     document.body.appendChild(dom.createElement("p", {content: "OKAY."}));
     document.body.appendChild(dom.createElement("p", {content: e.constructor.name + ": " + e.message}));
   }
   //*** Test 4 ***************************
   document.body.appendChild(dom.createElement("h2", {content: "Test 4: Wrong year"}));
   try {
     let b1 = new Book({isbn: "123456789X", title: "Hello world", year: 1122});
     document.body.appendChild(dom.createElement("p", {content: "FAILED!"}));
   } catch (e) {
     document.body.appendChild(dom.createElement("p", {content: "OKAY."}));
     document.body.appendChild(dom.createElement("p", {content: e.constructor.name + ": " + e.message}));
   }
   try {
     let b1 = new Book({isbn: "123456789X", title: "Hello world", year: 2025});
     document.body.appendChild(dom.createElement("p", {content: "FAILED!"}));
   } catch (e) {
     document.body.appendChild(dom.createElement("p", {content: "OKAY."}));
     document.body.appendChild(dom.createElement("p", {content: e.constructor.name + ": " + e.message}));
   }
   //*** Test 5 ***************************
   document.body.appendChild(dom.createElement("h2", {content: "Test 5: Deactivate Validation"}));
   try {
     bUSINESSoBJECT.areConstraintsToBeChecked = false;
     let b1 = new Book({isbn: "123456789X", title: "Hello world", year: 22});
     document.body.appendChild(dom.createElement("p", {content: "OKAY."}));
   } catch (e) {
     document.body.appendChild(dom.createElement("p", {content: "FAILED!"}));
     document.body.appendChild(dom.createElement("p", {content: e.constructor.name + ": " + e.message}));
   }
   //*** Test 6 ***************************
   document.body.appendChild(dom.createElement("h2", {content: "Test 6: Enumeration Attribute"}));
   bUSINESSoBJECT.areConstraintsToBeChecked = true;
   try {
     let b1 = new Book({isbn: "123456789X", title: "Hello world", year: 2022, category: 2});
     document.body.appendChild(dom.createElement("p", {content: "OKAY."}));
   } catch (e) {
     document.body.appendChild(dom.createElement("p", {content: "FAILED!"}));
     document.body.appendChild(dom.createElement("p", {content: e.constructor.name + ": " + e.message}));
   }
   try {
     // the value 5 exceeds the defined enumeration literals for category
     let b1 = new Book({isbn: "123456789X", title: "Hello world", year: 2022, category: 5});
     document.body.appendChild(dom.createElement("p", {content: "FAILED! ConstraintViolation not recognized."}));
   } catch (e) {
     document.body.appendChild(dom.createElement("p", {content: "OKAY."}));
     document.body.appendChild(dom.createElement("p", {content: e.constructor.name + ": " + e.message}));
   }
   //*** Test 7 ***************************
   document.body.appendChild(dom.createElement("h2", {content: "Test 7: Referential Integrity"}));
   try {
     let p1 = new Publisher({name:"Springer", address:"Berlin, Germany"});
     let b6 = new Book({isbn: "123456789X", title:"Hello world", year: 2022, publisher:"Spring"});
     document.body.appendChild(dom.createElement("p", {content: "FAILED!"}));
   } catch (e) {
     document.body.appendChild(dom.createElement("p", {content: "OKAY."}));
     document.body.appendChild(dom.createElement("p", {content: e.constructor.name + ": " + e.message}));
     test("Should be a ReferentialIntegrityConstraintViolation", e.constructor.name === "ReferentialIntegrityConstraintViolation");
     if (test.okay) {
       document.body.appendChild(dom.createElement("p", {content: "OKAY."}));
     } else {
       document.body.appendChild(dom.createElement("p", {content: "FAILED! Wrong type of ConstraintViolation."}));
     }
   }
 } catch (e) {
   console.log( e.constructor.name +": "+ e.message);
 }
 </script>
</body>
</html>

