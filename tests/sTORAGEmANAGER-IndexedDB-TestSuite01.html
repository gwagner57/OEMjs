<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <base href="." />
  <meta charset="utf-8">
  <title>sTORAGEmANAGER-IndexedDB Test Suite 01</title>
  <meta name="viewport" content="width=device-width, initial-scale = 1.0" />
  <link rel="stylesheet" href="../css/normalize.css" />
  <style>
    body { padding: 8px;}
    .failure {color: red;}
    .info {color: blue;}
    .okay {color: green;}
  </style>
</head>
<body>
 <h1>sTORAGEmANAGER-IndexedDB Test Suite 01: Basic Issues</h1>

 <script type="module">
 import dom from "../lib/dom.mjs";
 import eNUMERATION from "../src/eNUMERATION.mjs";
 import {dt} from "../src/datatypes.mjs";
 import bUSINESSoBJECT from "../src/bUSINESSoBJECT.mjs";
 import sTORAGEmANAGER from "../src/storage/sTORAGEmANAGER.mjs";
 import Book from "../apps/minimal/js/Book.mjs";

 /****************************************
 *** Test code **************************
 ****************************************/


 //*** Test 1 - Add **************************
 document.body.appendChild(dom.createElement("h2", {content: "Test 1: Creating a database and adding records"}));

 import app from "../apps/minimal/js/app.mjs";

 document.body.appendChild(dom.createElement("p",
     {content: `The "MinApp" IndexedDB should now contain book records.`}));

 //*** Test 2 ***************************
 document.body.appendChild(dom.createElement("h2", {content:"Test 2: Retrieving a record"}));
 let bookRec=null;
 try {
   bookRec = await app.storageManager.retrieve( Book, "0553345842");
   document.body.appendChild(dom.createElement("p",
       {content: `Success! Retrieved book: ${JSON.stringify(bookRec)}`}));
 } catch (e) {
   console.error( e.constructor.name +": "+ e.message);
 }
 //*** Test 3 - RetrieveAll ***************************
 document.body.appendChild(dom.createElement("h2", {content:"Test 3: Retrieving all records"}));
 let bookRecords=null;
 try {
   bookRecords = await app.storageManager.retrieveAll( Book);
   document.body.appendChild(dom.createElement("p",
       {content: `Success! Retrieved books:\n ${JSON.stringify( Book.instances)}`}));
 } catch (e) {
   console.log( e.constructor.name +": "+ e.message);
 }

  //*** Test 4 - Update ********************
  document.body.appendChild(dom.createElement("h2", {content:"Test 4: Update Record"}));
  try {
    const bookId = "0553345842";
    const book = await app.storageManager.retrieve( Book, bookId);
    document.body.appendChild(dom.createElement("p",
        {content: `Book title before update: ${book.title}`}));
    await app.storageManager.update( Book, bookId, {title: book.title+"***"});
    const bookUpdate = await app.storageManager.retrieve( Book, bookId);
    document.body.appendChild(dom.createElement("p",
        {content: `Book title after update: ${bookUpdate.title}`}));
  } catch (e) {
    console.log( e.constructor.name +": "+ e.message);
  }
 /*
  //*** Test 5 - Destroy ********************
  document.body.appendChild(dom.createElement("h2", {content:"Test 5: Destroy"}));
  try {
    // Book b2 already updated in previous test case, compare only ISBN
    const bookDestroy = await app.storageManager.retrieve( Book, b2.isbn);
    if (JSON.stringify(bookDestroy.isbn)===JSON.stringify(b2.isbn)) {
      document.body.appendChild(dom.createElement("p",
          {content: `Book is still available. Retrieved book: ${JSON.stringify(bookDestroy)}`}));
    }
    const destroyed = await app.storageManager.destroy(Book, await bookDestroy.isbn);
    if (destroyed) {
      document.body.appendChild(dom.createElement("p",
          {content: `Book is detroyed: ${JSON.stringify(bookUpdate)}`}));
    }
  } catch (e) {
    console.log( e.constructor.name +": "+ e.message);
  }

  //*** Test 6 - ClearTable ********************
  document.body.appendChild(dom.createElement("h2", {content: "Test 6: ClearTable"}));
  try {
    let bookRecords = await app.storageManager.retrieveAll(Book);
    // Destroyed a book before clearing table -> length - 1
    if (bookRecords.length === 3) {
      document.body.appendChild(dom.createElement("p",
          {content: `Clearing Books: ${JSON.stringify(bookRecords)}`}));
    } else {
      document.body.appendChild(dom.createElement("p",
          {content: `Expacted two books in table, received ${bookRecords.length}`}));
    }
    // clear Book table
    await app.storageManager.clearTable(Book);
    // check no book awailable
    bookRecords = await app.storageManager.retrieveAll(Book);
    if (bookRecords.length === 0) {
      document.body.appendChild(dom.createElement("p",
          {content: "Success, table `Book` is empty!"}));
    }
    
  } catch (e) {
   console.log( e.constructor.name +": "+ e.message);
  }

  //*** Test 7 - ClearDB ********************
  document.body.appendChild(dom.createElement("h2", {content: "Test 7: ClearDB"}));
  try {
    let pubs = await app.storageManager.retrieveAll(Publisher);
    if (pubs.length > 0) {
      document.body.appendChild(dom.createElement("p",
          {content: "Database contains entries, clearing DB now!"}));
    } else {
      document.body.appendChild(dom.createElement("p",
          {content: "Failed: Database already empty!"}));
    }
    await app.storageManager.clearDB();
    pubs = await app.storageManager.retrieveAll(Publisher);
    let books = await app.storageManager.retrieveAll(Book);
    if (pubs.length === 0 && books.length === 0) {
      document.body.appendChild(dom.createElement("p",
          {content: "Success: Database empty!"}));
    } else {
      document.body.appendChild(dom.createElement("p",
          {content: "Failed: Database not cleared!"}));
    }

  } catch (e) {
   console.log( e.constructor.name +": "+ e.message);
  }
*/
 </script>
</body>
</html>

