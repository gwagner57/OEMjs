<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <base href="." />
  <meta charset="utf-8">
  <title>sTORAGEmANAGER-IndexedDB Test Suite 01</title>
  <meta name="viewport" content="width=device-width, initial-scale = 1.0" />
  <link rel="stylesheet" href="../css/normalize.css" />
  <style>
    body { padding: 8px;}
    .failure {color: red;}
    .info {color: blue;}
    .okay {color: green;}
  </style>
</head>
<body>
 <h1>sTORAGEmANAGER-IndexedDB Test Suite 01: Basic Issues</h1>

 <script type="module">
 import dom from "../lib/dom.mjs";
 import {test, showSuccessMessage} from "./test.js";
 import eNUMERATION from "../src/eNUMERATION.mjs";
 import dt from "../src/datatypes.mjs";
 import bUSINESSoBJECT from "../src/bUSINESSoBJECT.mjs";
 import sTORAGEmANAGER from "../src/storage/sTORAGEmANAGER.mjs";

 /****************************************
 *** Test code **************************
 ****************************************/
 const BookCategoryEL = new eNUMERATION("BookCategoryEL", ["novel","biography",
   "textbook","other"]);

 class Publisher extends bUSINESSoBJECT {
   constructor ({name, address}) {
     super( name);
     this.address = address;
   }
 }
 Publisher.properties = {
   "name": {range:"NonEmptyString", isIdAttribute: true, min: 2, max: 20},
   "address": {range:"NonEmptyString", min: 5, max: 50},
 }
 Publisher.setup();

 class Book extends bUSINESSoBJECT {
   constructor ({isbn, title, year, publisher, edition, category}) {
     super( isbn);
     this.title = title;
     this.year = year;
     if (publisher) this.publisher = publisher;
     if (edition) this.edition = edition;
     if (category) this.category = category;
   }
 }
 Book.properties = {
   "isbn": {range:"NonEmptyString", isIdAttribute: true, label:"ISBN", pattern:/\b\d{9}(\d|X)\b/,
     patternMessage:"The ISBN must be a 10-digit string or a 9-digit string followed by 'X'!"},
   "title": {range:"NonEmptyString", min: 2, max: 50},
   "year": {range:"Integer", min: 1459, max: () => (new Date()).getFullYear() + 1},
   "publisher": {range:"Publisher", optional: true},
   "edition": {range:"PositiveInteger", optional: true},
   "category": {range: BookCategoryEL, optional: true}
 }
 try {
   Book.setup();
 } catch (e) {
   console.log( e.constructor.name +": "+ e.message);
 }

 const storeMan = new sTORAGEmANAGER({adapterName:"IndexedDB", dbName: "TestSuite01",
                      createLog: true, validateBeforeSave: true});

 //*** Test 1 - Add **************************
 document.body.appendChild(dom.createElement("h2", {content: "Test 1: Creating a database and adding records"}));
 const classes = Object.keys( dt.classes).map( className => dt.classes[className]).
 filter( c => !c.isAbstract && !c.isComplexDatatype);
 try {
   storeMan.deleteDatabase();  // or storeMan.clearDB()
   storeMan.createEmptyDb( classes);
 } catch (e) {
   console.log( e.constructor.name +": "+ e.message);
 }

 const b1 = new Book({isbn: "1234567890", title:"A novel", year: 2022, category: BookCategoryEL.NOVEL});
 const p1 = new Publisher({name:"Springer", address:"Berlin, Germany"});
 // a book object with a publisher object reference
 const b2 = new Book({isbn: "123456789X", title:"Textbook 1", year: 2021,
   category: BookCategoryEL.TEXTBOOK, publisher: p1});
 // a book object with a publisher ID reference
 const b3 = new Book({isbn: "123123123X", title:"Textbook 2", year: 2021,
   category: BookCategoryEL.TEXTBOOK, publisher: "Springer"});
 try {
   await storeMan.add( Publisher, p1.toRecord());
   await storeMan.add( Book, [b1.toRecord(), b2.toRecord(), b3.toRecord()]);
 } catch (e) {
   console.log( e.constructor.name +": "+ e.message);
 }
 document.body.appendChild(dom.createElement("p",
     {content: `The "TestSuite01" IndexedDB should contain a "Springer" record in the "publishers" table
        and three records in the "books" table, two of them having the ID reference "Springer" as the value of
        their "publisher" field.`}));

 //*** Test 2 ***************************
 document.body.appendChild(dom.createElement("h2", {content:"Test 2: Retrieving a record"}));
 let bookRec=null;
 try {
   bookRec = await storeMan.retrieve( Book, "123456789X");
   if (JSON.stringify(bookRec)===JSON.stringify(b2.toRecord())) {
     document.body.appendChild(dom.createElement("p",
         {content: `Success! Retrieved book: ${JSON.stringify(bookRec)}`}));
   }
 } catch (e) {
   console.log( e.constructor.name +": "+ e.message);
 }
 //*** Test 3 - RetrieveAll ***************************
 document.body.appendChild(dom.createElement("h2", {content:"Test 3: Retrieving all records"}));
 let bookRecords=null;
 try {
   bookRecords = await storeMan.retrieveAll( Book);
   const books = Object.keys(Book.instances).map( isbn =>  Book.instances[isbn].toRecord());
   if (bookRecords.length === books.length) { //  && books.every( b => bookRecords.includes(b))
     document.body.appendChild(dom.createElement("p",
         {content: `Success! Retrieved books:`}));
     const tableEl = document.createElement("table");
     const tableHeadEl = document.createElement("tHead");
     const tableBodyEl = document.createElement("tBody");
     let row=null;
     tableEl.appendChild( tableHeadEl);
     tableEl.appendChild( tableBodyEl);
     document.body.appendChild( tableEl);

     row = tableHeadEl.insertRow(-1);
     Object.keys( Book.properties).forEach( function (prop) {
       row.insertCell(-1).textContent = Book.properties[prop].label || prop;
     });
     for (let i=0; i < bookRecords.length; i++) {
       row = tableBodyEl.insertRow(-1);
       Object.keys( Book.properties).forEach( function (prop) {
         row.insertCell(-1).textContent = bookRecords[i][prop];
       });
     }
   }
 } catch (e) {
   console.log( e.constructor.name +": "+ e.message);
 }


  //*** Test 4 - Update ********************
  document.body.appendChild(dom.createElement("h2", {content:"Test 4: Update Record"}));
  try {
    const bookId = "123456789X";
    const book = await storeMan.retrieve( Book, bookId);
    if (JSON.stringify(book)===JSON.stringify(b2.toRecord())) {
      document.body.appendChild(dom.createElement("p",
          {content: `Before Update! Retrieved book: ${JSON.stringify(book)}`}));
    }
    await storeMan.update(Book, bookId, {title:"Updated book title"});
    const bookUpdate = await storeMan.retrieve( Book, bookId);
    if (bookUpdate.title === "Updated book title") {
      document.body.appendChild(dom.createElement("p",
          {content: `After Update! Retrieved book: ${JSON.stringify(bookUpdate)}`}));
    } else {
      document.body.appendChild(dom.createElement("p", {content: `Update failed! ${JSON.stringify(bookUpdate)}`}));
    }
  } catch (e) {
    console.log( e.constructor.name +": "+ e.message);
  }
/*
  //*** Test 5 - Destroy ********************
  document.body.appendChild(dom.createElement("h2", {content:"Test 5: Destroy"}));
  try {
    const bookId = "123456789X";
    const bookDestroy = await storeMan.retrieve( Book, bookId);
    if (JSON.stringify(bookDestroy)===JSON.stringify(b2.toRecord())) {
      document.body.appendChild(dom.createElement("p",
          {content: `Book is still available. Retrieved book: ${JSON.stringify(bookDestroy)}`}));
    }
    const destroyed = await storeMan.destroy(Book, bookId);
    if (destroyed) {
      document.body.appendChild(dom.createElement("p",
          {content: `Book is detroyed: ${JSON.stringify(bookUpdate)}`}));
    }
  } catch (e) {
    console.log( e.constructor.name +": "+ e.message);
  }

  //*** Test 6 - ClearTable ********************
  document.body.appendChild(dom.createElement("h2", {content: "Test 6: ClearTable"}));
  try {
    let bookRecords = await storeMan.retrieveAll(Book);
    // Destroyed a book before clearing table -> length - 1
    if (bookRecords.length === 3) {
      document.body.appendChild(dom.createElement("p",
          {content: `Clearing Books: ${JSON.stringify(bookRecords)}`}));
    } else {
      document.body.appendChild(dom.createElement("p",
          {content: `Expacted two books in table, received ${bookRecords.length}`}));
    }
    // clear Book table
    await storeMan.clearTable(Book);
    // check no book awailable
    bookRecords = await storeMan.retrieveAll(Book);
    if (bookRecords.length === 0) {
      document.body.appendChild(dom.createElement("p",
          {content: "Success, table `Book` is empty!"}));
    }
    
  } catch (e) {
   console.log( e.constructor.name +": "+ e.message);
  }

  //*** Test 7 - ClearDB ********************
  document.body.appendChild(dom.createElement("h2", {content: "Test 7: ClearDB"}));
  try {
    let pubs = await storeMan.retrieveAll(Publisher);
    if (pubs.length > 0) {
      document.body.appendChild(dom.createElement("p",
          {content: "Database contains entries, clearing DB now!"}));
    } else {
      document.body.appendChild(dom.createElement("p",
          {content: "Failed: Database already empty!"}));
    }
    await storeMan.clearDB();
    pubs = await storeMan.retrieveAll(Publisher);
    let books = await storeMan.retrieveAll(Book);
    if (pubs.length === 0 && books.length === 0) {
      document.body.appendChild(dom.createElement("p",
          {content: "Success: Database empty!"}));
    } else {
      document.body.appendChild(dom.createElement("p",
          {content: "Failed: Database not cleared!"}));
    }

  } catch (e) {
   console.log( e.constructor.name +": "+ e.message);
  }

 */
 </script>
</body>
</html>

